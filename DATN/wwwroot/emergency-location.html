<!DOCTYPE html>
<html>
<head>
    <title>V·ªã Tr√≠ Kh·∫©n C·∫•p</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f8f9fa; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .alert-header { background-color: #f44336; color: white; padding: 15px; text-align: center; }
        .patient-info { background-color: #fff9f9; border: 1px solid #ffcdd2; padding: 15px; margin: 15px 0; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .contact-info { font-size: 1.2em; font-weight: bold; color: #d32f2f; }
        #map { height: 400px; width: 100%; border-radius: 4px; margin: 15px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .action-buttons { display: flex; justify-content: space-between; margin: 15px 0; flex-wrap: wrap; gap: 10px; }
        .action-buttons button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 1; min-width: 120px; }
        .btn-call { background-color: #4CAF50; color: white; }
        .btn-mail { background-color: #2196F3; color: white; }
        .btn-map { background-color: #673AB7; color: white; }
        .btn-resolve { background-color: #FF9800; color: white; }
        .timestamp { font-size: 0.9em; color: #757575; margin-top: 10px; }
        .loading { display: flex; justify-content: center; align-items: center; height: 200px; font-weight: bold; color: #666; }
        .error-message { background-color: #ffebee; border: 1px solid #ffcdd2; padding: 15px; margin: 15px 0; border-radius: 4px; color: #c62828; }
        .debug-container { margin-top: 20px; padding: 15px; background-color: #f0f0f0; border-radius: 4px; }
        .input-group { display: flex; gap: 10px; margin-top: 10px; }
        .input-group input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .input-group button { padding: 8px 15px; background-color: #607D8B; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .help-text { font-size: 0.9em; color: #666; margin-top: 8px; }
        @media (max-width: 600px) {
            .action-buttons { flex-direction: column; gap: 10px; }
            .action-buttons button { width: 100%; margin-bottom: 5px; }
        }
    </style>
</head>
<body>
    <div class="alert-header">
        <h1>üö® C·∫¢NH B√ÅO KH·∫®N C·∫§P üö®</h1>
    </div>
    
    <div class="container">
        <div id="loading" class="loading">ƒêang t·∫£i th√¥ng tin kh·∫©n c·∫•p...</div>
        <div id="error-container" style="display: none;" class="error-message"></div>
        
        <div id="debug-container" class="debug-container" style="display: none;">
            <h3>C√¥ng C·ª• Ki·ªÉm Tra</h3>
            <p>Kh√¥ng t√¨m th·∫•y GPS ID h·ª£p l·ªá. Vui l√≤ng nh·∫≠p ID ƒë·ªÉ xem th√¥ng tin kh·∫©n c·∫•p:</p>
            <div class="input-group">
                <input type="number" id="manual-gpsid" placeholder="Nh·∫≠p GPS ID">
                <button onclick="useManualId()">Ki·ªÉm Tra</button>
            </div>
            <p class="help-text">URL ƒë√∫ng ph·∫£i c√≥ ƒë·ªãnh d·∫°ng: /emergency-location/{id} ho·∫∑c ?id={id}</p>
            
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <h4>Ki·ªÉm Tra K·∫øt N·ªëi API</h4>
                <button onclick="testApiConnection()" style="background-color: #546E7A; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;">
                    Ki·ªÉm Tra K·∫øt N·ªëi
                </button>
                <div id="api-status" style="margin-top: 10px; font-size: 0.9em;"></div>
            </div>
        </div>
        
        <div id="content" style="display: none;">
            <div class="patient-info">
                <h2>Th√¥ng tin b·ªánh nh√¢n</h2>
                <p><strong>T√™n:</strong> <span id="patientName"></span></p>
                <p class="contact-info">Li√™n h·ªá ngay: <span id="phoneNumber"></span></p>
                <p><strong>Email:</strong> <span id="email"></span></p>
                <p class="timestamp">Th·ªùi gian b√°o ƒë·ªông: <span id="recordedTime"></span></p>
            </div>
            
            <h2>V·ªã tr√≠ hi·ªán t·∫°i</h2>
            <div id="map"></div>
            
            <div class="action-buttons">
                <button class="btn-call" onclick="callPatient()">G·ªçi Ngay</button>
                <button class="btn-mail" onclick="emailPatient()">G·ª≠i Email</button>
                <button class="btn-map" onclick="openInOpenStreetMap()">Xem Trong OSM</button>
                <button class="btn-resolve" id="resolveBtn" onclick="resolveEmergency()">ƒê√£ H·ªó Tr·ª£</button>
            </div>
        </div>
    </div>

    <script>
        
        let gpsId;
        let warningId = 0;
        let patientLatitude, patientLongitude;
        const apiBaseUrl = "http://localhost:5062"; 
        
        
        function getGpsIdFromUrl() {
            
            const pathParts = window.location.pathname.split('/');
            if (pathParts.length >= 2) {
                
                for (let i = 0; i < pathParts.length - 1; i++) {
                    if (pathParts[i] === "emergency-location") {
                        const potentialId = pathParts[i+1];
                        if (potentialId && !isNaN(parseInt(potentialId))) {
                            console.log("Found gpsId in URL path:", potentialId);
                            return potentialId;
                        }
                    }
                }
            }
            
            
            const urlParams = new URLSearchParams(window.location.search);
            const queryId = urlParams.get('id');
            if (queryId && !isNaN(parseInt(queryId))) {
                console.log("Found gpsId in query param:", queryId);
                return queryId;
            }
            
            console.log("No valid gpsId found in URL");
            return null;
        }
        
        
        async function loadEmergencyData() {
            try {
                
                if (!gpsId || isNaN(parseInt(gpsId))) {
                    throw new Error("GPS ID kh√¥ng h·ª£p l·ªá");
                }
                
                document.getElementById('loading').style.display = 'flex';
                document.getElementById('content').style.display = 'none';
                document.getElementById('error-container').style.display = 'none';
                document.getElementById('debug-container').style.display = 'none';
                
                
                const numericGpsId = parseInt(gpsId);
                const apiUrl = `${apiBaseUrl}/api/EmergencyButton/location/${numericGpsId}`;
                
                console.log("Fetching from:", apiUrl);
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    console.log("Response status:", response.status);
                    const responseText = await response.text();
                    console.log("Response text:", responseText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Data received:", data);
                
               
                document.getElementById('patientName').textContent = data.patientName;
                document.getElementById('phoneNumber').textContent = data.phoneNumber;
                document.getElementById('email').textContent = data.email || 'Kh√¥ng c√≥';
                document.getElementById('recordedTime').textContent = data.formattedTime;
                
                
                warningId = data.warningId;
                patientLatitude = data.latitude;
                patientLongitude = data.longitude;
                
                
                if (!warningId) {
                    const resolveBtn = document.getElementById('resolveBtn');
                    resolveBtn.disabled = true;
                    resolveBtn.style.backgroundColor = '#9E9E9E';
                    resolveBtn.title = 'Kh√¥ng c√≥ c·∫£nh b√°o li√™n k·∫øt';
                }
                
                
                const map = L.map('map').setView([data.latitude, data.longitude], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                
                L.marker([data.latitude, data.longitude]).addTo(map)
                    .bindPopup(`${data.patientName} ƒëang ·ªü ƒë√¢y!`)
                    .openPopup();
                
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                console.error('Error fetching location data:', error);
                document.getElementById('loading').style.display = 'none';
                
                const errorContainer = document.getElementById('error-container');
                errorContainer.textContent = 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu v·ªã tr√≠: ' + error.message;
                errorContainer.style.display = 'block';
                
                
                document.getElementById('debug-container').style.display = 'block';
            }
        }
        
        
        function callPatient() {
            const phoneNumber = document.getElementById('phoneNumber').textContent;
            window.location.href = `tel:${phoneNumber}`;
        }
        
        
        function emailPatient() {
            const email = document.getElementById('email').textContent;
            if (email && email !== 'Kh√¥ng c√≥') {
                window.location.href = `mailto:${email}?subject=Ph·∫£n h·ªìi th√¥ng b√°o kh·∫©n c·∫•p&body=T√¥i ƒë√£ nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o kh·∫©n c·∫•p c·ªßa b·∫°n v√† ƒëang li√™n h·ªá ƒë·ªÉ h·ªó tr·ª£.`;
            } else {
                alert('Kh√¥ng c√≥ ƒë·ªãa ch·ªâ email ƒë·ªÉ li√™n h·ªá.');
            }
        }
        
       
        function openInOpenStreetMap() {
            if (patientLatitude && patientLongitude) {
                const osmUrl = `https://www.openstreetmap.org/#map=16/${patientLatitude}/${patientLongitude}`;
                window.open(osmUrl, '_blank');
            } else {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu t·ªça ƒë·ªô');
            }
        }
        
        
        async function resolveEmergency() {
            if (!warningId) {
                alert('Kh√¥ng t√¨m th·∫•y ID c·∫£nh b√°o.');
                return;
            }
            
            if (confirm('B·∫°n c√≥ ch·∫Øc ƒë√£ h·ªó tr·ª£ ng∆∞·ªùi d√πng n√†y?')) {
                try {
                    const token = localStorage.getItem('token'); 
                    
                    const response = await fetch(`${apiBaseUrl}/api/EmergencyButton/resolve/${warningId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        alert('ƒê√£ ƒë√°nh d·∫•u t√¨nh hu·ªëng kh·∫©n c·∫•p l√† ƒë√£ gi·∫£i quy·∫øt.');
                        const btnResolve = document.getElementById('resolveBtn');
                        btnResolve.disabled = true;
                        btnResolve.textContent = "ƒê√£ Gi·∫£i Quy·∫øt";
                        btnResolve.style.backgroundColor = "#9E9E9E";
                    } else {
                        if (response.status === 401) {
                            alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán h√†nh ƒë·ªông n√†y.');
                        } else {
                            alert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i c·∫£nh b√°o.');
                        }
                    }
                } catch (error) {
                    console.error('Error resolving emergency:', error);
                    alert('ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i sau.');
                }
            }
        }
        
        
        function useManualId() {
            const inputId = document.getElementById('manual-gpsid').value;
            if (inputId && !isNaN(parseInt(inputId))) {
                gpsId = inputId;
                loadEmergencyData();
            } else {
                alert("ID kh√¥ng h·ª£p l·ªá! Vui l√≤ng nh·∫≠p s·ªë.");
            }
        }
        
        
        async function testApiConnection() {
            try {
                const statusElement = document.getElementById('api-status');
                statusElement.textContent = "ƒêang ki·ªÉm tra k·∫øt n·ªëi...";
                statusElement.style.color = "#666";
                
                
                const response = await fetch(`${apiBaseUrl}/api/EmergencyButton/test`);
                
                if (response.ok) {
                    const data = await response.json();
                    statusElement.textContent = `‚úì K·∫øt n·ªëi th√†nh c√¥ng! Server time: ${data.timestamp}`;
                    statusElement.style.color = "green";
                } else {
                    statusElement.textContent = `‚úó K·∫øt n·ªëi th·∫•t b·∫°i. Status: ${response.status}`;
                    statusElement.style.color = "red";
                }
            } catch (error) {
                const statusElement = document.getElementById('api-status');
                statusElement.textContent = `‚úó L·ªói k·∫øt n·ªëi: ${error.message}`;
                statusElement.style.color = "red";
            }
        }
        
       
        function initialize() {
          
            gpsId = getGpsIdFromUrl();
            
           
            if (gpsId) {
                loadEmergencyData();
            } else {
               
                document.getElementById('loading').style.display = 'none';
                document.getElementById('debug-container').style.display = 'block';
                document.getElementById('error-container').textContent = 'Kh√¥ng t√¨m th·∫•y ID t·ªça ƒë·ªô trong URL.';
                document.getElementById('error-container').style.display = 'block';
            }
        }
        
        
        document.addEventListener('DOMContentLoaded', function() {
            const manualInput = document.getElementById('manual-gpsid');
            manualInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    useManualId();
                }
            });
        });
        
       
        window.onload = initialize;
    </script>
</body>
</html>